<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Redline — Real-Time Text Comparison</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f1117;
    --surface: #181a24;
    --surface-alt: #1e2130;
    --border: #2a2d3e;
    --border-hover: #3d4160;
    --text: #e0e2ef;
    --text-muted: #8187a8;
    --text-dim: #565c7e;
    --accent: #7c8aff;
    --accent-glow: rgba(124, 138, 255, 0.12);
    --del-bg: rgba(255, 80, 80, 0.13);
    --del-text: #ff6b6b;
    --del-border: rgba(255, 80, 80, 0.25);
    --ins-bg: rgba(80, 220, 130, 0.10);
    --ins-text: #50dc82;
    --ins-border: rgba(80, 220, 130, 0.25);
    --radius: 12px;
    --radius-sm: 8px;
    --font: 'DM Sans', -apple-system, sans-serif;
    --mono: 'DM Mono', 'Menlo', monospace;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: var(--font);
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Subtle grain overlay */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 9999;
  }

  .app {
    max-width: 1400px;
    margin: 0 auto;
    padding: 32px 28px 60px;
  }

  /* HEADER */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 32px;
    flex-wrap: wrap;
    gap: 16px;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo-icon {
    width: 36px; height: 36px;
    background: linear-gradient(135deg, var(--del-text), var(--accent));
    border-radius: 10px;
    display: grid; place-items: center;
    font-weight: 700; font-size: 16px; color: #fff;
    letter-spacing: -0.5px;
    box-shadow: 0 4px 20px rgba(124, 138, 255, 0.2);
  }

  .logo h1 {
    font-size: 22px;
    font-weight: 700;
    letter-spacing: -0.5px;
    background: linear-gradient(135deg, var(--text), var(--text-muted));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .logo h1 span {
    font-weight: 400;
    color: var(--text-muted);
    -webkit-text-fill-color: var(--text-muted);
  }

  /* MAIN LAYOUT */
  .main-grid {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 16px;
    margin-bottom: 20px;
    align-items: start;
  }

  .editor-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    transition: border-color 0.2s;
  }
  .editor-panel:focus-within {
    border-color: var(--border-hover);
  }

  .panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
  }

  .panel-label {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--text-dim);
  }

  .panel-label.original { color: var(--del-text); opacity: 0.7; }
  .panel-label.revised  { color: var(--ins-text); opacity: 0.7; }

  .char-count {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text-dim);
  }

  textarea {
    width: 100%;
    min-height: 220px;
    padding: 16px;
    background: transparent;
    border: none;
    outline: none;
    color: var(--text);
    font-family: var(--font);
    font-size: 14.5px;
    line-height: 1.7;
    resize: vertical;
  }
  textarea::placeholder { color: var(--text-dim); }

  /* Text A panel stretches to fill */
  .text-a-panel {
    position: sticky;
    top: 32px;
  }
  .text-a-panel textarea {
    min-height: 400px;
  }

  /* RIGHT COLUMN: comparison rows */
  .comparison-rows {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .comparison-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    animation: fadeUp 0.3s ease;
  }

  .row-actions {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .action-btn {
    font-family: var(--font);
    font-size: 12px;
    font-weight: 500;
    padding: 5px 10px;
    border-radius: 16px;
    border: 1.5px solid var(--border);
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .action-btn:hover { border-color: var(--border-hover); color: var(--text); }
  .action-btn svg { transition: transform 0.3s; }
  .action-btn:hover svg { transform: rotate(180deg); }

  .action-btn.remove-btn:hover { border-color: var(--del-text); color: var(--del-text); }
  .action-btn.remove-btn:hover svg { transform: none; }

  /* REDLINE OUTPUT */
  .output-wrapper {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }

  .output-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
  }

  .output-label {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--accent);
    opacity: 0.8;
  }

  .stats {
    display: flex;
    gap: 16px;
  }

  .stat {
    font-family: var(--mono);
    font-size: 11px;
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .stat .dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    display: inline-block;
  }
  .stat.del-stat .dot { background: var(--del-text); }
  .stat.del-stat { color: var(--del-text); }
  .stat.ins-stat .dot { background: var(--ins-text); }
  .stat.ins-stat { color: var(--ins-text); }

  .output-body {
    padding: 20px;
    min-height: 100px;
    font-size: 14.5px;
    line-height: 1.8;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .output-body .placeholder-text {
    color: var(--text-dim);
    font-style: italic;
  }

  /* Diff spans */
  .diff-del {
    background: var(--del-bg);
    color: var(--del-text);
    text-decoration: line-through;
    text-decoration-color: rgba(255, 107, 107, 0.5);
    border-radius: 3px;
    padding: 1px 3px;
    margin: 0 1px;
  }

  .diff-ins {
    background: var(--ins-bg);
    color: var(--ins-text);
    text-decoration: underline;
    text-decoration-style: solid;
    text-decoration-color: rgba(80, 220, 130, 0.4);
    text-underline-offset: 3px;
    border-radius: 3px;
    padding: 1px 3px;
    margin: 0 1px;
  }

  /* ADD BUTTON */
  .add-row-btn {
    font-family: var(--font);
    font-size: 13px;
    font-weight: 500;
    padding: 10px 20px;
    border-radius: 20px;
    border: 1.5px dashed var(--border);
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
  }
  .add-row-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: var(--accent-glow);
  }

  /* LEGEND */
  .legend {
    display: flex;
    gap: 24px;
    margin-top: 16px;
    padding: 0 4px;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: var(--text-dim);
  }

  .legend-sample-del {
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 3px;
    background: var(--del-bg);
    color: var(--del-text);
    text-decoration: line-through;
  }

  .legend-sample-ins {
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 3px;
    background: var(--ins-bg);
    color: var(--ins-text);
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  /* ANIMATIONS */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* RESPONSIVE */
  @media (max-width: 768px) {
    .app { padding: 20px 16px 40px; }
    .main-grid { grid-template-columns: 1fr; }
    .comparison-row { grid-template-columns: 1fr; }
    .text-a-panel { position: static; }
    .text-a-panel textarea { min-height: 220px; }
    header { flex-direction: column; align-items: flex-start; }
    .stats { gap: 10px; }
    .legend { flex-wrap: wrap; gap: 12px; }
  }
</style>
</head>
<body>

<div class="app">
  <!-- HEADER -->
  <header>
    <div class="logo">
      <div class="logo-icon">R</div>
      <h1>Redline <span>· text diff</span></h1>
    </div>
  </header>

  <!-- MAIN LAYOUT -->
  <div class="main-grid">
    <!-- LEFT: Text A (anchor) -->
    <div class="editor-panel text-a-panel">
      <div class="panel-header">
        <span class="panel-label original">Text A · Original</span>
        <span class="char-count" id="countA">0 chars</span>
      </div>
      <textarea id="textA" placeholder="Paste or type the original text here…" spellcheck="false">The quick brown fox jumps over the lazy dog. This sentence is used for testing purposes. It contains all the letters of the alphabet and is widely recognized around the world.</textarea>
    </div>

    <!-- RIGHT: Comparison rows -->
    <div class="comparison-rows" id="comparisonRows">
      <!-- Row B is created by JS on init -->
    </div>
  </div>

  <!-- LEGEND -->
  <div class="legend">
    <div class="legend-item"><span class="legend-sample-del">removed</span> Text deleted from A</div>
    <div class="legend-item"><span class="legend-sample-ins">added</span> Text added in B</div>
  </div>
</div>

<script>
  const textA = document.getElementById('textA');
  const countA = document.getElementById('countA');
  const rowsContainer = document.getElementById('comparisonRows');

  let nextLabel = 'B'; // next letter for labeling
  const rows = []; // track all comparison row data

  function nextLetter() {
    const letter = nextLabel;
    nextLabel = String.fromCharCode(nextLabel.charCodeAt(0) + 1);
    return letter;
  }

  // Swap a row's text with Text A
  function swapWithA(rowData) {
    const tmp = textA.value;
    textA.value = rowData.textarea.value;
    rowData.textarea.value = tmp;
    updateCountA();
    runAllDiffs();
  }

  // Remove a comparison row
  function removeRow(rowData) {
    rowData.el.remove();
    const idx = rows.indexOf(rowData);
    if (idx > -1) rows.splice(idx, 1);
  }

  // Create a comparison row
  function addComparisonRow(initialText, removable) {
    const label = nextLetter();
    const rowEl = document.createElement('div');
    rowEl.className = 'comparison-row';

    // Textarea panel
    const editorPanel = document.createElement('div');
    editorPanel.className = 'editor-panel';

    const panelHeader = document.createElement('div');
    panelHeader.className = 'panel-header';

    const panelLabel = document.createElement('span');
    panelLabel.className = 'panel-label revised';
    panelLabel.textContent = `Text ${label} · Revised`;

    const actions = document.createElement('div');
    actions.className = 'row-actions';

    const charCount = document.createElement('span');
    charCount.className = 'char-count';
    charCount.textContent = '0 chars';

    // Swap button
    const swapBtn = document.createElement('button');
    swapBtn.className = 'action-btn';
    swapBtn.title = 'Swap with Text A';
    swapBtn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg> Swap';

    actions.appendChild(charCount);
    actions.appendChild(swapBtn);

    // Remove button (only for added rows)
    let removeBtn = null;
    if (removable) {
      removeBtn = document.createElement('button');
      removeBtn.className = 'action-btn remove-btn';
      removeBtn.title = 'Remove this comparison';
      removeBtn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
      actions.appendChild(removeBtn);
    }

    panelHeader.appendChild(panelLabel);
    panelHeader.appendChild(actions);
    editorPanel.appendChild(panelHeader);

    const ta = document.createElement('textarea');
    ta.placeholder = `Paste or type revised text here…`;
    ta.spellcheck = false;
    ta.value = initialText || '';
    editorPanel.appendChild(ta);

    // Output panel
    const outputWrapper = document.createElement('div');
    outputWrapper.className = 'output-wrapper';

    const outputHeader = document.createElement('div');
    outputHeader.className = 'output-header';

    const outputLabel = document.createElement('span');
    outputLabel.className = 'output-label';
    outputLabel.textContent = 'Redline Output';

    const statsDiv = document.createElement('div');
    statsDiv.className = 'stats';

    const delStat = document.createElement('span');
    delStat.className = 'stat del-stat';
    delStat.innerHTML = '<span class="dot"></span> <span class="del-count">0</span> removed';

    const insStat = document.createElement('span');
    insStat.className = 'stat ins-stat';
    insStat.innerHTML = '<span class="dot"></span> <span class="ins-count">0</span> added';

    statsDiv.appendChild(delStat);
    statsDiv.appendChild(insStat);
    outputHeader.appendChild(outputLabel);
    outputHeader.appendChild(statsDiv);
    outputWrapper.appendChild(outputHeader);

    const outputBody = document.createElement('div');
    outputBody.className = 'output-body';
    outputBody.innerHTML = '<span class="placeholder-text">Start typing to see the redline comparison…</span>';
    outputWrapper.appendChild(outputBody);

    rowEl.appendChild(editorPanel);
    rowEl.appendChild(outputWrapper);

    // Insert before the add button (if present)
    const addBtn = rowsContainer.querySelector('.add-row-btn');
    if (addBtn) {
      rowsContainer.insertBefore(rowEl, addBtn);
    } else {
      rowsContainer.appendChild(rowEl);
    }

    const rowData = {
      el: rowEl,
      label: label,
      textarea: ta,
      charCount: charCount,
      outputBody: outputBody,
      delCountEl: delStat.querySelector('.del-count'),
      insCountEl: insStat.querySelector('.ins-count'),
    };
    rows.push(rowData);

    // Event listeners
    swapBtn.addEventListener('click', () => swapWithA(rowData));
    if (removeBtn) {
      removeBtn.addEventListener('click', () => removeRow(rowData));
    }
    ta.addEventListener('input', () => {
      runDiffForRow(rowData);
    });

    // Initial diff
    runDiffForRow(rowData);

    return rowData;
  }

  // Run diff for a single row
  function runDiffForRow(rowData) {
    const a = textA.value;
    const b = rowData.textarea.value;

    rowData.charCount.textContent = `${b.length} chars`;

    if (!a && !b) {
      rowData.outputBody.innerHTML = '<span class="placeholder-text">Start typing to see the redline comparison…</span>';
      rowData.delCountEl.textContent = '0';
      rowData.insCountEl.textContent = '0';
      return;
    }

    // Pass 1: word-level diff
    const wordDiff = Diff.diffWords(a, b);

    let html = '';
    let delCount = 0;
    let insCount = 0;

    const esc = s => s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

    // Group consecutive removed/added parts into blocks
    const groups = [];
    let i = 0;
    while (i < wordDiff.length) {
      const part = wordDiff[i];
      if (part.removed || part.added) {
        // Accumulate consecutive removed/added parts
        let removed = '';
        let added = '';
        while (i < wordDiff.length && (wordDiff[i].removed || wordDiff[i].added)) {
          if (wordDiff[i].removed) removed += wordDiff[i].value;
          else added += wordDiff[i].value;
          i++;
        }
        groups.push({ type: 'change', removed, added });
      } else {
        groups.push({ type: 'equal', value: part.value });
        i++;
      }
    }

    // Render each group
    groups.forEach(group => {
      if (group.type === 'equal') {
        html += esc(group.value);
        return;
      }

      const { removed, added } = group;

      if (removed && added) {
        // Paired modification — try character-level refinement
        const charDiff = Diff.diffChars(removed, added);
        const totalChars = Math.max(removed.length, added.length);
        let removedChars = 0, addedChars = 0;
        charDiff.forEach(p => { if (p.removed) removedChars += p.value.length; else if (p.added) addedChars += p.value.length; });
        const changedChars = Math.max(removedChars, addedChars);

        if (changedChars / totalChars <= 0.3) {
          // Small change — render character-level diff
          charDiff.forEach(cp => {
            const t = esc(cp.value);
            if (cp.removed) {
              html += `<span class="diff-del">${t}</span>`;
              delCount += cp.value.length;
            } else if (cp.added) {
              html += `<span class="diff-ins">${t}</span>`;
              insCount += cp.value.length;
            } else {
              html += t;
            }
          });
        } else {
          // Large change — render as single removed + single added block
          html += `<span class="diff-del">${esc(removed)}</span>`;
          html += `<span class="diff-ins">${esc(added)}</span>`;
          delCount += removed.length;
          insCount += added.length;
        }
      } else if (removed) {
        html += `<span class="diff-del">${esc(removed)}</span>`;
        delCount += removed.length;
      } else if (added) {
        html += `<span class="diff-ins">${esc(added)}</span>`;
        insCount += added.length;
      }
    });

    rowData.outputBody.innerHTML = html;
    rowData.delCountEl.textContent = delCount;
    rowData.insCountEl.textContent = insCount;
  }

  // Re-diff all rows (called when Text A changes)
  function runAllDiffs() {
    rows.forEach(row => runDiffForRow(row));
  }

  function updateCountA() {
    countA.textContent = `${textA.value.length} chars`;
  }

  // Listen for input on Text A
  textA.addEventListener('input', () => {
    updateCountA();
    runAllDiffs();
  });

  // Initialize: create Text B row, then add button
  addComparisonRow(
    'The quick red fox leaps over the lazy dog. This phrase is used for demonstration purposes. It contains most of the letters of the alphabet and is widely known around the world.',
    false
  );

  // Add the "+ Add" button
  const addBtn = document.createElement('button');
  addBtn.className = 'add-row-btn';
  addBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Add Comparison';
  addBtn.addEventListener('click', () => addComparisonRow('', true));
  rowsContainer.appendChild(addBtn);

  // Initial count
  updateCountA();
</script>

</body>
</html>
